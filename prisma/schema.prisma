// Prisma schema for SQLite
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Configuração 100% global: eliminar distinções por guild
model GlobalConfig {
  id                     Int      @id @default(autoincrement())
  // Verificação
  verifyPanelChannelId   String?
  mainRoleId             String?
  verifiedRoleId         String?
  // Insta
  instaBoysChannelId     String?
  instaGirlsChannelId    String?
  photosChannelId        String?
  photosMaleChannelId    String?
  photosFemaleChannelId  String?
  // Mute feature (global)
  muteVoiceRoleId        String?  // Cargo aplicado a usuários silenciados por mutecall
  muteVoiceUnlockChannelId String? // Canal de voz para desbloqueio automático
  muteVoiceLogChannelId  String?
  muteChatRoleId         String?  // Cargo aplicado por mute de chat
  muteChatLogChannelId   String?
  // Suporte (global)
  supportPanelChannelId String?
  supportLogChannelId   String?
  supportRolesGlobal    SupportRoleGlobal[]
  // Relacionamentos globais
  ticketPingRolesGlobal TicketPingRoleGlobal[]
  // AutoMod
  autoModConfig        AutoModConfig?
  // Moderação
  moderationConfig     ModerationConfig?
  // Mute config avançada
  mutePermissions      MutePermission[]
  voiceMutes           VoiceMute[]
  chatMutes            ChatMute[]
  vipConfig            VipConfig?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model TicketPingRoleGlobal {
  id              Int  @id @default(autoincrement())
  globalConfigId  Int
  roleId          String
  config          GlobalConfig @relation(fields: [globalConfigId], references: [id], onDelete: Cascade)

  @@unique([globalConfigId, roleId])
}

model SupportRoleGlobal {
  id             Int  @id @default(autoincrement())
  globalConfigId Int
  roleId         String
  config         GlobalConfig @relation(fields: [globalConfigId], references: [id], onDelete: Cascade)

  @@unique([globalConfigId, roleId])
}

model AutoModConfig {
  id                        Int                  @id @default(autoincrement())
  globalConfigId            Int                  @unique
  punishmentType            String               @default("DELETE")
  punishmentDurationSeconds Int?
  reason                    String               @default("Palavra Proibida")
  config                    GlobalConfig         @relation(fields: [globalConfigId], references: [id], onDelete: Cascade)
  blockedWords              AutoModBlockedWord[]
  createdAt                 DateTime             @default(now())
  updatedAt                 DateTime             @updatedAt
}

model AutoModBlockedWord {
  id              Int           @id @default(autoincrement())
  autoModConfigId Int
  word            String
  autoModConfig   AutoModConfig @relation(fields: [autoModConfigId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@unique([autoModConfigId, word])
}

model ModerationConfig {
  id                   Int                     @id @default(autoincrement())
  globalConfigId       Int                     @unique
  banEnabled           Boolean                 @default(false)
  banLogChannelId      String?
  banDmEnabled         Boolean                 @default(false)
  banDmMessage         String?
  banDmContactId       String?
  castigoEnabled       Boolean                 @default(false)
  castigoLogChannelId  String?
  castigoDmEnabled     Boolean                 @default(false)
  castigoDmMessage     String?
  castigoDmContactId   String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  config               GlobalConfig            @relation(fields: [globalConfigId], references: [id], onDelete: Cascade)
  permissions          ModerationPermission[]
}

model ModerationPermission {
  id                  Int               @id @default(autoincrement())
  moderationConfigId  Int
  commandType         String
  roleId              String
  config              ModerationConfig  @relation(fields: [moderationConfigId], references: [id], onDelete: Cascade)

  @@unique([moderationConfigId, commandType, roleId])
}

model MutePermission {
  id             Int          @id @default(autoincrement())
  globalConfigId Int
  commandType    String
  roleId         String
  config         GlobalConfig @relation(fields: [globalConfigId], references: [id], onDelete: Cascade)

  @@unique([globalConfigId, commandType, roleId])
}

model SupportTicket {
  id               Int      @id @default(autoincrement())
  threadId         String   @unique
  channelId        String
  guildId          String
  openerId         String
  openerTag        String?
  closedBy         String?
  closedAt         DateTime?
  transcriptUrl    String?
  logMessageId     String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model VerifiedUserGlobal {
  id          Int      @id @default(autoincrement())
  userId      String   @unique
  verifiedAt  DateTime @default(now())
  verifiedBy  String?
  sex         String?
}

// Insta global (sem guildId)
model InstaPostGlobal {
  id           String   @id // messageId do webhook
  channelId    String
  authorId     String
  mediaUrl     String
  mediaType    String   // image|video|gif|other
  createdAt    DateTime @default(now())
  likeCount    Int      @default(0)
  commentCount Int      @default(0)

  likes     InstaLikeGlobal[]
  comments  InstaCommentGlobal[]
}

model InstaLikeGlobal {
  id        Int     @id @default(autoincrement())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  post      InstaPostGlobal @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
}

model InstaCommentGlobal {
  id        Int     @id @default(autoincrement())
  postId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  post      InstaPostGlobal @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model InstaWinnerGlobal {
  id               Int     @id @default(autoincrement())
  channelId        String
  postId           String
  winnerUserId     String
  likeCount        Int
  winnerMessageId  String
  createdAt        DateTime @default(now())
}

model Guild {
  id            String  @id @map("guild_id")
  name          String?
  posseUserId   String? // superusuário da guild que pode tudo
  createdAt     DateTime @default(now())
  commandConfigs CommandConfig[]
  auditLogs     AuditLog[]
  config        GuildConfig?
  verifiedUsers VerifiedUser[]
  instaPosts    InstaPost[]
  instaWinners  InstaWinner[]
}

model VoiceMute {
  id               Int      @id @default(autoincrement())
  globalConfigId   Int
  guildId          String
  userId           String
  moderatorId      String?
  reason           String?
  durationSeconds  Int?
  expiresAt        DateTime?
  commandChannelId String?
  endedAt          DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  config           GlobalConfig @relation(fields: [globalConfigId], references: [id], onDelete: Cascade)

  @@index([guildId, userId])
}

model ChatMute {
  id               Int      @id @default(autoincrement())
  globalConfigId   Int
  guildId          String
  userId           String
  moderatorId      String?
  reason           String?
  durationSeconds  Int?
  expiresAt        DateTime?
  commandChannelId String?
  endedAt          DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  config           GlobalConfig @relation(fields: [globalConfigId], references: [id], onDelete: Cascade)

  @@index([guildId, userId])
}

model CommandConfig {
  id        Int     @id @default(autoincrement())
  guildId   String
  name      String
  enabled   Boolean @default(true)
  allowedUsers AllowedUser[]
  allowedRoles AllowedRole[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@unique([guildId, name])
}

model AllowedUser {
  id        Int    @id @default(autoincrement())
  commandId Int
  userId    String
  command   CommandConfig @relation(fields: [commandId], references: [id], onDelete: Cascade)

  @@unique([commandId, userId])
}

model AllowedRole {
  id        Int    @id @default(autoincrement())
  commandId Int
  roleId    String
  command   CommandConfig @relation(fields: [commandId], references: [id], onDelete: Cascade)

  @@unique([commandId, roleId])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  guildId   String
  actorId   String
  action    String
  details   String?
  createdAt DateTime  @default(now())

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

model GuildConfig {
  id                 Int     @id @default(autoincrement())
  guildId            String  @unique
  // Verificação
  verifyPanelChannelId String?
  mainRoleId         String? // Cargo principal que pode verificar/encerrar
  verifiedRoleId     String? // Cargo "Verificado"
  // Cargos para mencionar ao abrir ticket
  ticketPingRoles    TicketPingRole[]
  // Insta channels
  instaBoysChannelId  String?
  instaGirlsChannelId String?

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

model TicketPingRole {
  id        Int    @id @default(autoincrement())
  guildConfigId Int
  roleId    String

  config GuildConfig @relation(fields: [guildConfigId], references: [id], onDelete: Cascade)

  @@unique([guildConfigId, roleId])
}

model VerifiedUser {
  id         Int      @id @default(autoincrement())
  guildId    String
  userId     String
  verifiedAt DateTime  @default(now())
  verifiedBy String?

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@unique([guildId, userId])
}

model InstaPost {
  // Usamos messageId do webhook como id
  id           String   @id
  guildId      String
  channelId    String
  authorId     String
  mediaUrl     String
  mediaType    String   // image|video|gif|other
  createdAt    DateTime @default(now())
  likeCount    Int      @default(0)
  commentCount Int      @default(0)

  likes     InstaLike[]
  comments  InstaComment[]

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

model InstaLike {
  id        Int     @id @default(autoincrement())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post InstaPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
}

model InstaComment {
  id        Int     @id @default(autoincrement())
  postId    String
  userId    String
  content   String
  createdAt DateTime @default(now())

  post InstaPost @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model InstaWinner {
  id            Int     @id @default(autoincrement())
  guildId       String
  channelId     String
  postId        String
  winnerUserId  String
  likeCount     Int
  winnerMessageId String // mensagem enviada avisando vencedor (para preservar)
  createdAt     DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

model VipConfig {
  id                Int               @id @default(autoincrement())
  globalConfigId    Int               @unique
  bonusRoleId       String?
  hideEmptyChannels Boolean           @default(true)
  allowManualTags   Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  config            GlobalConfig      @relation(fields: [globalConfigId], references: [id], onDelete: Cascade)
  setPermissions    VipSetPermission[]
  plans             VipPlan[]
}

model VipPlan {
  id                 Int              @id @default(autoincrement())
  vipConfigId        Int
  guildId            String
  name               String?
  durationDays       Int?
  vipRoleId          String?
  tagSeparatorRoleId String?
  callCategoryId     String?
  createdById        String?
  updatedById        String?
  isDraft            Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  config             VipConfig        @relation(fields: [vipConfigId], references: [id], onDelete: Cascade)
  memberships        VipMembership[]
}

model VipMembership {
  id                Int                  @id @default(autoincrement())
  vipPlanId         Int
  guildId           String
  userId            String               @unique
  startedAt         DateTime             @default(now())
  expiresAt         DateTime
  active            Boolean              @default(true)
  vipRoleId         String?
  bonusRoleId       String?
  tagRoleId         String?
  channelId         String?
  channelParentId   String?
  lastSetById       String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  plan              VipPlan              @relation(fields: [vipPlanId], references: [id], onDelete: Cascade)
  tag               VipTag?
  channel           VipChannel?
  logs              VipMembershipLog[]
}

model VipTag {
  id            Int           @id @default(autoincrement())
  membershipId  Int           @unique
  roleId        String?
  name          String?
  color         String?
  emoji         String?
  iconHash      String?
  iconData      Bytes?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  membership    VipMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  shares        VipTagShare[]
}

model VipChannel {
  id            Int           @id @default(autoincrement())
  membershipId  Int           @unique
  channelId     String?
  name          String?
  userLimit     Int?
  categoryId    String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  membership    VipMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  permissions   VipChannelPermission[]
}

model VipTagShare {
  id           Int      @id @default(autoincrement())
  vipTagId     Int
  targetUserId String
  createdById  String?
  createdAt    DateTime @default(now())
  tag          VipTag   @relation(fields: [vipTagId], references: [id], onDelete: Cascade)

  @@unique([vipTagId, targetUserId])
}

model VipChannelPermission {
  id             Int         @id @default(autoincrement())
  vipChannelId   Int
  targetUserId   String
  allowView      Boolean     @default(true)
  allowConnect   Boolean     @default(true)
  createdById    String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  vipChannel     VipChannel  @relation(fields: [vipChannelId], references: [id], onDelete: Cascade)

  @@unique([vipChannelId, targetUserId])
}

model VipSetPermission {
  id             Int        @id @default(autoincrement())
  vipConfigId    Int
  roleId         String
  createdAt      DateTime   @default(now())
  config         VipConfig  @relation(fields: [vipConfigId], references: [id], onDelete: Cascade)

  @@unique([vipConfigId, roleId])
}

model VipMembershipLog {
  id            Int           @id @default(autoincrement())
  membershipId  Int
  action        String
  amountDays    Int?
  actorId       String?
  metadata      String?
  createdAt     DateTime      @default(now())
  membership    VipMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
}

